<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<button id="b">录音</button>
<audio id="audio" controls></audio>
<!--<form id="uploadForm1">-->
<!--    <input type="file" name="file" accept="audio/*" style="display: none">-->
<!--</form>-->
<h1>语音转录</h1>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" accept="audio/*"><br><br>
    <button type="submit">上传并转录</button>
</form>
<h2>转录结果：</h2>
<pre id="result"></pre>
<script>
    let mediaRecorder;
    let audioChunks = [];
    let audioContext, analyser, microphone, javascriptNode;
    let isRecording = false;

    const startRecord = document.getElementById("startRecord");
    const stopRecord = document.getElementById("stopRecord");
    const btn = document.getElementById("b");
    const audio = document.getElementById("audio");
    const uploadForm = document.getElementById("uploadForm");

    const silenceThreshold = 0.05;
    const silenceTime = 1000;
    let lastSoundTime = Date.now();

    function initAudioContext(stream) {
        audioContext = new AudioContext();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
        microphone.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);
    }

    function startRecording() {
        isRecording = true;
        audioChunks = [];
        mediaRecorder.start({ bitRate: 128 });
    }

    function stopRecording() {
        isRecording = false;
        mediaRecorder.stop();
        javascriptNode.disconnect();
        microphone.disconnect();
        audioContext.close();

        const audioBlob = new Blob(audioChunks);
        audio.src = URL.createObjectURL(audioBlob);
    }
    btn.addEventListener("mousedown", function() {
        navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000 } })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                initAudioContext(stream);
                startRecording();

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    // 使用带有正确头部信息的函数创建 Blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audio.src = URL.createObjectURL(audioBlob);

                    const audioFile = new File([audioBlob], 'recorded.wav', { type: 'audio/wav' });

                    // 创建一个 <a> 元素
                    const downloadLink = document.createElement('a');
                    // 设置 <a> 元素的 href 属性为音频 URL
                    downloadLink.href = URL.createObjectURL(audioBlob);
                    // 设置 <a> 元素的 download 属性为希望用户下载时的文件名
                    downloadLink.download = 'recorded.wav';
                    // 将 <a> 元素添加到页面中
                    document.body.appendChild(downloadLink);
                    // 模拟用户点击下载链接
                    downloadLink.click();

                    // 获取文件输入元素
                    const fileInput = document.querySelector('input[name="file"]');
                    // 创建一个 DataTransfer 对象
                    const dataTransfer = new DataTransfer();
                    // 将新文件对象添加到 DataTransfer
                    dataTransfer.items.add(audioFile);
                    // 将 DataTransfer 对象赋值给文件输入元素
                    fileInput.files = dataTransfer.files;

                    const formData = new FormData(uploadForm);
                    // formData.append('file', audioBlob, 'recorded.wav');
                    formData.append('file', audioFile, 'recorded.wav');
                    console.log(formData)

                    fetch('http://region-3.seetacloud.com:19897/transcribe/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        console.log('请求结果')
                        console.log(result);
                        document.getElementById('result').textContent = result.text || result.error;
                    })
                    .catch(error => {
                        console.error('上传和转录失败:', error);
                    });
                });
            });
    });

    let audioElement;
    btn.addEventListener("mouseup", function() {
        if (isRecording) {
            stopRecording();
        }
    });
    // 语音文件转文字
    document.getElementById('uploadForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const fileInput = document.querySelector('input[type="file"]');
        // 获取选择的文件
        const selectedFile = fileInput.files[0];
        console.log('上传的文件类型为' + selectedFile.type)
        const audioElement = new Audio();
        audioElement.src = URL.createObjectURL(selectedFile);
        audioElement.play()

        const formData = new FormData(this);
        const response = await fetch('http://region-31.seetacloud.com:53112/transcribe/', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        console.log(result)
        document.getElementById('result').textContent = result.text || result.error
    })
</script>

</body>
</html>
